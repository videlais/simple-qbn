<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Management - SimpleQBN</title>
    <meta name="description" content="Because nothing about quality-based narratives is actually simple.">
    <link rel="stylesheet" href="/simple-qbn/assets/css/style.css">
</head>
<body>
    <div class="book">
        <nav class="sidebar">
  <div class="book-summary">
    <h2>SimpleQBN</h2>
    <ul class="summary">
      
      <li class="chapter ">
        
        <a href="/simple-qbn/">Introduction</a>
        
        
      </li>
      
      <li class="chapter has-children">
        
        <span class="section-title">History of Related Terms</span>
        
        
        <ul class="articles">
          
          <li>
            <a href="/simple-qbn/scenes">Scenes and Cycles (1983)</a>
          </li>
          
          <li>
            <a href="/simple-qbn/episodes">Episodes and Sequences (1989)</a>
          </li>
          
          <li>
            <a href="/simple-qbn/sculpturalmodel">Sculptural Hypertext Model (2001)</a>
          </li>
          
          <li>
            <a href="/simple-qbn/storylet">Storylet (2010)</a>
          </li>
          
          <li>
            <a href="/simple-qbn/qbn">Quality-Based Narrative (2010)</a>
          </li>
          
        </ul>
        
      </li>
      
      <li class="chapter has-children">
        
        <span class="section-title">Metaphors in SimpleQBN</span>
        
        
        <ul class="articles">
          
          <li>
            <a href="/simple-qbn/expressions">Expressions and QualitySet</a>
          </li>
          
          <li>
            <a href="/simple-qbn/cards">Decks and Cards</a>
          </li>
          
          <li>
            <a href="/simple-qbn/State">State Management</a>
          </li>
          
        </ul>
        
      </li>
      
      <li class="chapter has-children">
        
        <span class="section-title">Examples</span>
        
        
        <ul class="articles">
          
          <li>
            <a href="/simple-qbn/examples/deckbuilding">Deck Building</a>
          </li>
          
          <li>
            <a href="/simple-qbn/examples/storygates">Story Gates</a>
          </li>
          
          <li>
            <a href="/simple-qbn/examples/webbuild">Bundled for Web</a>
          </li>
          
        </ul>
        
      </li>
      
    </ul>
  </div>
</nav>

        <div class="book-body">
            <div class="body-inner">
                <div class="page-wrapper">
                    <div class="page-inner">
                        <div class="markdown-section">
<h1 id="state-management">State Management</h1>

<p>The <a href="./sculpturalmodel.md">sculptural model</a> defines a <em>context</em> cards can access and manipulate. The QBN model also describes <em>qualities</em> as conditional statements testing against some values. In SimpleQBN, this is explicitly called <strong>State</strong>.</p>

<p>SimpleQBN provides two distinct state management architectures that serve different use cases:</p>

<h2 id="original-state-architecture">Original State Architecture</h2>

<p>The <strong>State</strong> class stores key-value pairs and provides methods for manipulation: <em>set()</em>, <em>exists()</em>, <em>delete()</em>, <em>get()</em>, and <em>size()</em>. This architecture requires explicit state passing and manual availability checking.</p>

<h3 id="original-state-characteristics">Original State Characteristics</h3>

<ul>
  <li><strong>Manual state passing</strong>: You must explicitly pass the state to methods that need it</li>
  <li><strong>Synchronous operations</strong>: All state checks happen when you call them</li>
  <li><strong>Explicit control</strong>: You decide when and how to check card availability</li>
  <li><strong>Lightweight</strong>: Minimal overhead and memory usage</li>
</ul>

<h3 id="original-state-usage-patterns">Original State Usage Patterns</h3>

<p>It is common to create a new <strong>Deck</strong> and then immediately change its state to add values before adding any <strong>Cards</strong>. While, technically, <strong>Cards</strong> can be added first and then <strong>State</strong> updated, if any <strong>Cards</strong> have <em>qualities</em>, there must be some values in the <strong>State</strong> to test against before the method <em>draw()</em> is used.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">State</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">simple-qbn/State</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">Card</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">simple-qbn/Card</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">Deck</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">simple-qbn/Deck</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Create and populate state</span>
<span class="kd">const</span> <span class="nx">gameState</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">State</span><span class="p">();</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">health</span><span class="dl">'</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">level</span><span class="dl">'</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">hasKey</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

<span class="c1">// Create cards with quality requirements</span>
<span class="kd">const</span> <span class="nx">healCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Card</span><span class="p">(</span><span class="dl">'</span><span class="s1">Use healing potion</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$health &lt; 50</span><span class="dl">'</span><span class="p">]);</span>
<span class="kd">const</span> <span class="nx">levelCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Card</span><span class="p">(</span><span class="dl">'</span><span class="s1">Advanced training</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$level &gt;= 5</span><span class="dl">'</span><span class="p">]);</span>
<span class="kd">const</span> <span class="nx">doorCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Card</span><span class="p">(</span><span class="dl">'</span><span class="s1">Open locked door</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$hasKey == true</span><span class="dl">'</span><span class="p">]);</span>

<span class="c1">// Create deck and add cards</span>
<span class="kd">const</span> <span class="nx">deck</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Deck</span><span class="p">();</span>
<span class="nx">deck</span><span class="p">.</span><span class="nf">addCard</span><span class="p">(</span><span class="nx">healCard</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="nx">healCard</span><span class="p">.</span><span class="nx">qualities</span><span class="p">);</span>
<span class="nx">deck</span><span class="p">.</span><span class="nf">addCard</span><span class="p">(</span><span class="nx">levelCard</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="nx">levelCard</span><span class="p">.</span><span class="nx">qualities</span><span class="p">);</span>
<span class="nx">deck</span><span class="p">.</span><span class="nf">addCard</span><span class="p">(</span><span class="nx">doorCard</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="nx">doorCard</span><span class="p">.</span><span class="nx">qualities</span><span class="p">);</span>

<span class="c1">// Explicitly check availability by passing state</span>
<span class="kd">const</span> <span class="nx">availableCards</span> <span class="o">=</span> <span class="nx">deck</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="nx">gameState</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Available: </span><span class="p">${</span><span class="nx">availableCards</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="s2"> cards`</span><span class="p">);</span>

<span class="c1">// Update state and check again</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">health</span><span class="dl">'</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">hasKey</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">newAvailable</span> <span class="o">=</span> <span class="nx">deck</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="nx">gameState</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Now available: </span><span class="p">${</span><span class="nx">newAvailable</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="s2"> cards`</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="reactive-state-architecture">Reactive State Architecture</h2>

<p>The <strong>ReactiveState</strong> class extends the original State functionality with event-driven, automatic updates. When paired with reactive components, it provides real-time state synchronization.</p>

<h3 id="reactive-state-usage-patterns">Reactive State Usage Patterns</h3>

<p>State changes immediately trigger all connected components to recalculate their availability.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">ReactiveState</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">simple-qbn/reactive/State</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">ReactiveCard</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">simple-qbn/reactive/Card</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">ReactiveDeck</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">simple-qbn/reactive/Deck</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Create and populate reactive state</span>
<span class="kd">const</span> <span class="nx">gameState</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReactiveState</span><span class="p">();</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">health</span><span class="dl">'</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">level</span><span class="dl">'</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">hasKey</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

<span class="c1">// Create reactive cards</span>
<span class="kd">const</span> <span class="nx">healCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReactiveCard</span><span class="p">(</span><span class="dl">'</span><span class="s1">Use healing potion</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$health &lt; 50</span><span class="dl">'</span><span class="p">]);</span>
<span class="kd">const</span> <span class="nx">levelCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReactiveCard</span><span class="p">(</span><span class="dl">'</span><span class="s1">Advanced training</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$level &gt;= 5</span><span class="dl">'</span><span class="p">]);</span>
<span class="kd">const</span> <span class="nx">doorCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReactiveCard</span><span class="p">(</span><span class="dl">'</span><span class="s1">Open locked door</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$hasKey == true</span><span class="dl">'</span><span class="p">]);</span>

<span class="c1">// Create reactive deck bound to state</span>
<span class="kd">const</span> <span class="nx">deck</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReactiveDeck</span><span class="p">([</span><span class="nx">healCard</span><span class="p">,</span> <span class="nx">levelCard</span><span class="p">,</span> <span class="nx">doorCard</span><span class="p">],</span> <span class="nx">gameState</span><span class="p">);</span>

<span class="c1">// Subscribe to automatic availability updates</span>
<span class="nx">deck</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">((</span><span class="nx">availableCards</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Available: </span><span class="p">${</span><span class="nx">availableCards</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="s2"> cards`</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Subscribe to individual card changes</span>
<span class="nx">healCard</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">((</span><span class="nx">isAvailable</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Heal card available: </span><span class="p">${</span><span class="nx">isAvailable</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// State changes trigger all subscriptions automatically</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">health</span><span class="dl">'</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>    <span class="c1">// Triggers heal card and deck updates</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">hasKey</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>  <span class="c1">// Triggers door card and deck updates</span>

<span class="c1">// Batch updates for multiple changes</span>
<span class="nx">gameState</span><span class="p">.</span><span class="nf">batch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">level</span><span class="dl">'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="nx">gameState</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">health</span><span class="dl">'</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
<span class="p">});</span> <span class="c1">// All changes trigger together after batch completes</span>

<span class="c1">// Clean up when done</span>
<span class="nx">deck</span><span class="p">.</span><span class="nf">dispose</span><span class="p">();</span>
<span class="nx">healCard</span><span class="p">.</span><span class="nf">dispose</span><span class="p">();</span>
<span class="nx">levelCard</span><span class="p">.</span><span class="nf">dispose</span><span class="p">();</span>
<span class="nx">doorCard</span><span class="p">.</span><span class="nf">dispose</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="architecture-compatibility">Architecture Compatibility</h2>

<p><strong>Important</strong>: These two architectures are mutually exclusive:</p>

<ul>
  <li>Original classes (<code class="language-javascript highlighter-rouge"><span class="nx">State</span></code>, <code class="language-javascript highlighter-rouge"><span class="nx">Card</span></code>, <code class="language-javascript highlighter-rouge"><span class="nx">Deck</span></code>) cannot be used with reactive classes</li>
  <li>Reactive classes (<code class="language-javascript highlighter-rouge"><span class="nx">ReactiveState</span></code>, <code class="language-javascript highlighter-rouge"><span class="nx">ReactiveCard</span></code>, <code class="language-javascript highlighter-rouge"><span class="nx">ReactiveDeck</span></code>) cannot be used with original classes</li>
  <li>Choose one architecture for your entire application</li>
</ul>

<p>Both architectures use the same <a href="./expressions.md">Expression Language</a> for defining quality requirements, ensuring consistent condition syntax regardless of which state management approach you choose.</p>

</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
